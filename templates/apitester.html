<script>
    
    const checkNetworkError = (result) => {
        if( !result.response )
            return result;

        result.response = {
            status: 0,
            statusText: "Cannot connect. Please make sure you are connected to internet.",
        };
        throw result;
    }

    const checkResponseStatus = (response) => {
        if (response.status >= 200 && response.status < 300) {
            return response;
        }
        console.log(response)
        return response.json().then((json) => {
            return Promise.reject({
                status: response.status,
                statusText: response.statusText,
                ok: false,
                body: json,
            });
        });
    }

    const parseResponse = (response) => {
        if (response.status === 204 || response.status === 205) {
            return null;
        }
        if (response.headers.get("Content-Type").includes("json")) {
            return response.json();
        }
        return { response: response.blob() };
    }

    const handleResponse = (response) => {
        printResponse( url, response );
        return response;
    }

    const printResponse = (url, response) => {
        const { status } = response;

        let color_url = "#ddd";
        let color_status = "#ddd";

        switch (`${status}`) {
            case "200":
            case "201":
                color_status = "green";
                color_url = "#333";
                break;
            case "...":
                break;
            default:
                color_status = "red";
                color_url = "#333";
                break;
        }

        console.groupCollapsed(
            "%c[RestAPI]%c %s %s",
            `color:${color_status};font-family:monospace;font-weight:bold`,
            `color:${color_url};font-weight:normal;`,
            status,
            url
        );
        console.dir(response);
        console.groupEnd();
    }

    const handleError = (error) => {
        throw error;
    }

    const compileMethod = ( { url, method, defHeaders, defOptions, preload } ) =>
        ( options, headers ) => {
            if(preload) {
                [options, headers] = preload(options, headers);
            }

            if(headers)
                Object.assign( headers, defHeaders );
            else
                headers = defHeaders;

            if(options)
                Object.assign( options, defOptions );
            else
                options = defOptions;

            console.log({
                    method,
                    headers,
                    body: options,
                    redirect: 'follow'
                })
            
            return fetch( 
                url, 
                {
                    method,
                    headers,
                    body: options,
                    redirect: 'follow'
                }
            )
                .then( handleResponse )
                .catch( checkNetworkError )
                .then( checkResponseStatus )
                .then( parseResponse )
                .catch( handleError );
        };
</script>


<script>
    const testAuth = compileMethod( 
        'http://127.0.0.1:8000/api/v1/user/auth',
        'POST',
        {
            
        },
        {},
        null
    );

    testAuth({})
        .then( response => console.log(response) )
</script>